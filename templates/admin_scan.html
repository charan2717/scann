<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin QR Scan</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>Admin QR Scan & Approve</h2>

    <div id="qr-reader" style="width: 500px; margin-bottom:20px;"></div>

    <div>
        <label for="manual-regno">Or enter Reg No manually:</label>
        <input type="text" id="manual-regno" class="form-control" placeholder="Enter Reg No">
        <button id="manual-btn" class="btn btn-primary mt-2">Fetch Record</button>
    </div>

    <div id="record-info" class="mt-4" style="display:none;">
        <h4>Record Details</h4>
        <p><strong>Name:</strong> <span id="rec-name"></span></p>
        <p><strong>Reg No:</strong> <span id="rec-regno"></span></p>
        <p><strong>Email:</strong> <span id="rec-email"></span></p>
        <button id="approve-btn" class="btn btn-success">Approve</button>
    </div>
</div>

<script>
let lastScanned = null;

function showRecord(record) {
    document.getElementById('rec-name').innerText = record.data.Name;
    document.getElementById('rec-regno').innerText = record.data['Reg No'];
    document.getElementById('rec-email').innerText = record.data.Mail;
    document.getElementById('record-info').style.display = 'block';
}

async function fetchRecord(regno) {
    try {
        const res = await fetch(`/api/get_by_regno/${regno}`, {
            credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Record not found or not pending.');
        const data = await res.json();
        showRecord(data);
        lastScanned = data.data['Reg No'];
    } catch (err) {
        alert(err.message);
        lastScanned = null;
        document.getElementById('record-info').style.display = 'none';
    }
}

async function approveRecord() {
    if (!lastScanned) return;
    try {
        const res = await fetch(`/api/approve/${lastScanned}`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Failed to approve record.');
        alert('Record approved successfully!');
        document.getElementById('record-info').style.display = 'none';
        lastScanned = null;
    } catch (err) {
        alert(err.message);
    }
}

document.getElementById('approve-btn').addEventListener('click', approveRecord);
document.getElementById('manual-btn').addEventListener('click', () => {
    const val = document.getElementById('manual-regno').value.trim();
    if (val) fetchRecord(val);
});

// QR scanner
function onScanSuccess(decodedText, decodedResult) {
    if (decodedText && decodedText !== lastScanned) {
        fetchRecord(decodedText);
    }
}

function onScanFailure(error) {
    // optional: console.log(error);
}

let html5QrcodeScanner = new Html5Qrcode("qr-reader");
html5QrcodeScanner.start(
    { facingMode: "environment" }, 
    {
        fps: 10,
        qrbox: 250
    },
    onScanSuccess,
    onScanFailure
).catch(err => console.error(err));
</script>
</body>
</html>
