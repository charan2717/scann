<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Scan</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  #reader { width: 300px; margin-bottom: 20px; }
  #manual { margin-top: 20px; }
</style>
</head>
<body>
<h1>Scan QR Code or Enter Reg No</h1>

<div id="reader"></div>
<div id="scan-result"></div>

<div id="manual">
    <input type="text" id="regno-input" placeholder="Enter Reg No manually">
    <button onclick="fetchRecord()">Fetch Record</button>
</div>

<div id="record-details" style="margin-top:20px;"></div>

<script>
let lastRegNo = "";

function onScanSuccess(decodedText, decodedResult) {
    if(decodedText !== lastRegNo) {
        lastRegNo = decodedText;
        fetchRecord(decodedText);
    }
}

function onScanError(errorMessage) {}

let html5QrcodeScanner = new Html5Qrcode("reader");
html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess,
    onScanError
);

async function fetchRecord(manualRegNo = null) {
    const regno = manualRegNo || document.getElementById("regno-input").value.trim();
    if (!regno) return alert("Enter a Reg No!");

    try {
        const res = await fetch(`/api/get_by_regno/${regno}`);
        if (!res.ok) {
            const errText = await res.text();
            return alert("Error fetching record: " + errText);
        }
        const data = await res.json();
        displayRecord(data);
    } catch (err) {
        alert("Error: " + err.message);
    }
}

function displayRecord(data) {
    const div = document.getElementById("record-details");
    div.innerHTML = `
        <p><strong>Name:</strong> ${data.data.Name}</p>
        <p><strong>Reg No:</strong> ${data.regno}</p>
        <p><strong>Status:</strong> ${data.status}</p>
        <button onclick="approveRecord(${data.id})">Approve</button>
    `;
}

async function approveRecord(rec_id) {
    try {
        const res = await fetch(`/api/approve/${rec_id}`, { method: "POST" });
        const result = await res.json();
        if(result.ok) {
            alert("Record approved!");
            document.getElementById("record-details").innerHTML = "";
        } else {
            alert("Failed to approve: " + JSON.stringify(result));
        }
    } catch(err) {
        alert("Error: " + err.message);
    }
}
</script>
</body>
</html>
