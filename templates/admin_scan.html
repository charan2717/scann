<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin QR Scan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h3>QR Code Scanner</h3>
    <div id="reader"></div>
    <hr>
    <h4>Result</h4>
    <div id="result"></div>
</div>

<script>
    function displayRecord(data) {
        const resultDiv = document.getElementById('result');
        let html = '<table class="table table-bordered">';
        for (const key in data.data) {
            html += `<tr><th>${key}</th><td>${data.data[key]}</td></tr>`;
        }
        html += `<tr><th>Status</th><td>${data.status}</td></tr>`;
        if (data.status === 'pending') {
            html += `<tr><td colspan="2">
                        <button class="btn btn-success" onclick="approveRecord('${data.data['Reg No']}')">Approve</button>
                     </td></tr>`;
        }
        html += '</table>';
        resultDiv.innerHTML = html;
    }

    async function fetchRecord(regno) {
        try {
            const res = await fetch(`/api/get_by_regno/${regno}`);
            if (!res.ok) throw new Error('Record not found');
            const data = await res.json();
            displayRecord(data);
        } catch (err) {
            document.getElementById('result').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    }

    async function approveRecord(regno) {
        try {
            const res = await fetch(`/api/approve/${regno}`, { method: 'POST' });
            if (!res.ok) throw new Error('Failed to approve');
            alert('Record approved successfully!');
            fetchRecord(regno);
        } catch (err) {
            alert(err.message);
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        // decodedText is the text from QR code
        fetchRecord(decodedText);
        html5QrcodeScanner.clear(); // stop scanning after successful scan
    }

    const html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
</script>
</body>
</html>
